{
    "$schema": "http://json-schema.org/draft-07/schema",
    "title": "K8s Monitoring Rule",
    "type": "object",
    "uniqueness_keys": [
        "target",
        "rules.rule_type",
        "common.severity",
        "rules.severity"
    ],
    "properties": {
        "target": {
            "type": "object",
            "properties": {
                "environment": {
                    "type": "string",
                    "description": "The deployment environment (e.g., production, staging)",
                    "x-dynamic-options": {
                        "type": "prometheus_query",
                        "label": "environment",
                        "match": "up",
                        "dependencies": []
                    }
                },
                "namespace": {
                    "type": "string",
                    "description": "The K8s namespace",
                    "x-dynamic-options": {
                        "type": "prometheus_query",
                        "label": "namespace",
                        "match": "kube_namespace_created",
                        "dependencies": []
                    }
                },
                "workload": {
                    "type": "string",
                    "description": "The workload name (e.g., deployment name)",
                    "x-dynamic-options": {
                        "type": "prometheus_query",
                        "label": "deployment",
                        "match": "kube_deployment_created{namespace=\"{{.target.namespace}}\"}",
                        "dependencies": [
                            "target.namespace"
                        ]
                    }
                }
            },
            "required": [
                "environment",
                "namespace",
                "workload"
            ],
            "description": "The target entity for the rules"
        },
        "common": {
            "type": "object",
            "properties": {
                "for": {
                    "type": "string",
                    "description": "The duration to wait before firing the alert (e.g. 5m)",
                    "default": "5m"
                },
                "severity": {
                    "type": "string",
                    "enum": [
                        "critical",
                        "warning",
                        "info"
                    ],
                    "description": "The severity of the alert"
                },
                "labels": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Additional labels to add to the alert"
                },
                "annotations": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "string"
                    },
                    "description": "Additional annotations to add to the alert"
                }
            },
            "description": "Common properties shared by all rules"
        },
        "rules": {
            "type": "array",
            "items": {
                "oneOf": [
                    {
                        "type": "object",
                        "properties": {
                            "rule_type": {
                                "const": "cpu",
                                "description": "CPU usage monitoring"
                            },
                            "operator": {
                                "type": "string",
                                "enum": [
                                    ">",
                                    "<",
                                    ">=",
                                    "<=",
                                    "==",
                                    "!="
                                ],
                                "description": "The comparison operator"
                            },
                            "threshold": {
                                "type": "number",
                                "description": "The threshold value for the alert"
                            }
                        },
                        "required": [
                            "rule_type",
                            "operator",
                            "threshold"
                        ],
                        "additionalProperties": false,
                        "pipelines": [
                            {
                                "name": "test_cpu_pipeline",
                                "type": "dummy_always_pass",
                                "parameters": {}
                            }
                        ]
                    },
                    {
                        "type": "object",
                        "properties": {
                            "rule_type": {
                                "const": "ram",
                                "description": "Memory usage monitoring"
                            },
                            "operator": {
                                "type": "string",
                                "enum": [
                                    ">",
                                    "<",
                                    ">=",
                                    "<=",
                                    "==",
                                    "!="
                                ],
                                "description": "The comparison operator"
                            },
                            "threshold": {
                                "type": "number",
                                "description": "The threshold value for the alert"
                            }
                        },
                        "required": [
                            "rule_type",
                            "operator",
                            "threshold"
                        ],
                        "additionalProperties": false
                    },
                    {
                        "type": "object",
                        "properties": {
                            "rule_type": {
                                "const": "service_up",
                                "description": "Service availability monitoring"
                            },
                            "service_name": {
                                "type": "string",
                                "description": "The name of the service to check"
                            }
                        },
                        "required": [
                            "rule_type",
                            "service_name"
                        ],
                        "additionalProperties": false,
                        "pipelines": [
                            {
                                "name": "test_service_pipeline",
                                "type": "dummy_always_pass",
                                "parameters": {}
                            }
                        ]
                    }
                ]
            },
            "description": "List of rules to apply"
        }
    },
    "required": [
        "target",
        "rules"
    ],
    "datasource": {
        "type": "prometheus",
        "url": "http://localhost:9090"
    },
    "pipelines": [
        {
            "name": "test_global_pipeline",
            "type": "dummy_always_pass",
            "parameters": {}
        }
    ]
}